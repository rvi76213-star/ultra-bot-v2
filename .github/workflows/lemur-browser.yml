name: Deploy for Lemur Browser

on:
  workflow_dispatch:
    inputs:
      runtime:
        description: 'Runtime duration (minutes)'
        required: true
        default: '5'
        type: choice
        options:
          - '5'
          - '10'
          - '30'
          - '60'
      lemur_version:
        description: 'Lemur Browser version'
        required: false
        default: 'latest'
        type: string

jobs:
  deploy-lemur:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    # Step 1: Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    # Step 2: Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies for Lemur Browser..."
        npm ci --only=production
        echo "âœ… Dependencies installed"
        
    # Step 4: Validate appstate for Lemur
    - name: Validate appstate.json for Lemur
      id: validate-appstate
      run: |
        echo "ðŸ” Validating appstate.json for Lemur Browser..."
        
        if [ ! -f "src/secure/appstate.json" ]; then
          echo "âŒ appstate.json not found"
          echo "Lemur Browser requires appstate.json"
          echo "Please run: npm run login"
          echo "appstate-valid=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check appstate file size
        FILESIZE=$(wc -c < "src/secure/appstate.json")
        if [ $FILESIZE -lt 100 ]; then
          echo "âŒ appstate.json is too small or empty"
          echo "appstate-valid=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… appstate.json is valid for Lemur Browser"
        echo "appstate-valid=true" >> $GITHUB_OUTPUT
        
    # Step 5: Create Lemur Browser specific setup
    - name: Create Lemur setup files
      run: |
        echo "ðŸ”§ Creating Lemur Browser setup files..."
        
        # Create Lemur specific README
        cat > LEMUR_GUIDE.md << 'EOF'
        # ðŸ¤– YOUR CRUSH Bot - Lemur Browser Guide
        
        ## ðŸ“± Lemur Browser Setup
        
        ### Requirements:
        - Lemur Browser installed
        - Termux or similar terminal
        - Facebook account credentials
        
        ### Installation Steps:
        
        1. **Download the bot files** in Lemur Browser
        2. **Extract files** to a folder
        3. **Open Termux** from Lemur Browser
        4. **Navigate to bot directory**:
           ```bash
           cd /storage/emulated/0/Download/messenger-bot/
           ```
        5. **Run setup script**:
           ```bash
           chmod +x lemur-setup.sh
           ./lemur-setup.sh
           ```
        6. **Login to Facebook** when prompted
        7. **Start the bot**:
           ```bash
           npm start
           ```
        
        ### Lemur Browser Tips:
        - Enable "Desktop site" mode for better GitHub access
        - Allow Lemur to access storage
        - Keep screen on during setup
        - Use Lemur's download manager
        
        ### Bot Commands (Lemur Optimized):
        ```
        !help - Show commands
        !info - Bot information
        !startfun chor - Start chor fun
        !stopfun - Stop fun
        ```
        
        ### Support:
        - Developer: RANA (MASTER ðŸª“)
        - Email: ranaeditz333@gmail.com
        - Telegram: @rana_editz_00
        
        ### Lemur Compatibility:
        âœ… Node.js scripts work
        âœ… Facebook login works
        âœ… Auto-run capability
        âœ… Background execution
        EOF
        
        # Create Lemur setup script
        cat > lemur-setup.sh << 'EOF'
        #!/bin/bash
        
        echo "==========================================="
        echo "ðŸ¤– YOUR CRUSH Bot - Lemur Browser Setup"
        echo "ðŸ‘‘ RANA (MASTER ðŸª“)"
        echo "==========================================="
        
        # Colors for output
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m' # No Color
        
        echo -e "${BLUE}ðŸ“± Lemur Browser Bot Setup${NC}"
        echo ""
        
        # Check if running in Termux/Lemur environment
        if [ -d "/data/data/com.termux" ]; then
          echo -e "${GREEN}âœ… Running in Termux environment${NC}"
        else
          echo -e "${YELLOW}âš ï¸ Not in Termux. Some features may not work.${NC}"
        fi
        
        # Check Node.js
        if ! command -v node &> /dev/null; then
          echo -e "${RED}âŒ Node.js not found!${NC}"
          echo "Install Node.js in Termux:"
          echo "  pkg install nodejs"
          exit 1
        fi
        
        NODE_VERSION=$(node --version | cut -d'v' -f2)
        echo -e "${GREEN}âœ… Node.js found: v$NODE_VERSION${NC}"
        
        # Check npm
        if ! command -v npm &> /dev/null; then
          echo -e "${RED}âŒ npm not found!${NC}"
          exit 1
        fi
        
        echo -e "${GREEN}âœ… npm found: $(npm --version)${NC}"
        
        # Install dependencies
        echo -e "${BLUE}ðŸ“¦ Installing dependencies...${NC}"
        npm install
        
        # Check appstate
        if [ ! -f "src/secure/appstate.json" ]; then
          echo -e "${YELLOW}âš ï¸ appstate.json not found${NC}"
          echo "You need to login to Facebook first."
          echo ""
          read -p "Do you want to login now? (y/n): " -n 1 -r
          echo
          if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${BLUE}ðŸ” Starting Facebook login...${NC}"
            npm run login
          else
            echo -e "${YELLOW}â„¹ï¸ You can login later with: npm run login${NC}"
          fi
        else
          echo -e "${GREEN}âœ… appstate.json found${NC}"
        fi
        
        # Create Lemur specific config
        echo -e "${BLUE}âš™ï¸ Creating Lemur configuration...${NC}"
        
        # Update config for Lemur
        if [ -f "config/config.json" ]; then
          # Backup original config
          cp config/config.json config/config.json.backup
          
          # Update for Lemur
          cat > config/lemur-config.json << 'EOL'
        {
          "prefix": "!",
          "admins": [],
          "autoAddFriend": true,
          "autoShare": true,
          "maxGroups": 20,
          "logLevel": "info",
          "language": "bn",
          "ownerName": "RANA (MASTER ðŸª“)",
          "ownerLocation": "Faridpur, Dhaka, Bangladesh",
          "lemurOptimized": true,
          "lowMemoryMode": true,
          "browser": "lemur"
        }
        EOL
          
          echo -e "${GREEN}âœ… Lemur configuration created${NC}"
        fi
        
        # Create Lemur start script
        cat > start-lemur.sh << 'EOL'
        #!/bin/bash
        
        echo "ðŸš€ Starting bot in Lemur Browser mode..."
        
        # Set Lemur specific environment variables
        export LEMUR_BROWSER=true
        export NODE_OPTIONS="--max-old-space-size=512"
        
        # Start the bot
        npm start
        
        echo "Bot stopped. Exit code: $?"
        EOL
        
        chmod +x start-lemur.sh
        
        echo ""
        echo -e "${GREEN}âœ… SETUP COMPLETED!${NC}"
        echo ""
        echo -e "${BLUE}ðŸ“‹ NEXT STEPS:${NC}"
        echo "1. If not logged in: ${GREEN}npm run login${NC}"
        echo "2. Start bot: ${GREEN}./start-lemur.sh${NC}"
        echo "3. For normal start: ${GREEN}npm start${NC}"
        echo ""
        echo -e "${YELLOW}ðŸ’¡ Lemur Tips:${NC}"
        echo "â€¢ Keep Lemur Browser open"
        echo "â€¢ Enable background operation"
        echo "â€¢ Monitor in Termux"
        echo ""
        echo -e "${BLUE}ðŸ“ž Support:${NC}"
        echo "Developer: RANA (MASTER ðŸª“)"
        echo "Email: ranaeditz333@gmail.com"
        
        echo "==========================================="
        EOF
        
        chmod +x lemur-setup.sh
        
        # Create Lemur optimized package.json
        cat > package-lemur.json << 'EOF'
        {
          "name": "messenger-bot-lemur",
          "version": "2.0.0-lemur",
          "description": "YOUR CRUSH Bot optimized for Lemur Browser",
          "main": "src/index.js",
          "scripts": {
            "start": "LEMUR_MODE=true node src/index.js",
            "start-lemur": "LEMUR_MODE=true NODE_OPTIONS='--max-old-space-size=512' node src/index.js",
            "login": "node login.js",
            "lemur-setup": "./lemur-setup.sh",
            "lemur-test": "node lemur-test.js"
          },
          "dependencies": {
            "facebook-chat-api": "github:ntkhang03/fb-chat-api",
            "axios": "^1.6.0",
            "fs-extra": "^11.2.0",
            "chalk": "^4.1.2"
          },
          "lemurSettings": {
            "optimized": true,
            "lowMemory": true,
            "compatible": true
          }
        }
        EOF
        
        echo "âœ… Lemur setup files created"
        
    # Step 6: Run Lemur compatibility test
    - name: Run Lemur compatibility test
      if: steps.validate-appstate.outputs.appstate-valid == 'true'
      run: |
        echo "ðŸ§ª Running Lemur compatibility tests..."
        
        # Create test script
        cat > lemur-test.js << 'EOF'
        console.log("ðŸ§ª Lemur Browser Compatibility Test");
        console.log("===================================");
        
        // Test 1: Check Node.js modules
        console.log("\n1. Testing required modules...");
        try {
          require('fs');
          require('path');
          require('fs-extra');
          console.log("âœ… Basic modules work");
        } catch (e) {
          console.log("âŒ Module error:", e.message);
        }
        
        // Test 2: Check file system access
        console.log("\n2. Testing file system...");
        try {
          const fs = require('fs');
          fs.writeFileSync('lemur-test.txt', 'Lemur test successful');
          fs.readFileSync('lemur-test.txt', 'utf8');
          fs.unlinkSync('lemur-test.txt');
          console.log("âœ… File system access works");
        } catch (e) {
          console.log("âŒ File system error:", e.message);
        }
        
        // Test 3: Check memory usage
        console.log("\n3. Checking memory...");
        const used = process.memoryUsage();
        console.log(`Memory usage:`);
        console.log(`- RSS: ${Math.round(used.rss / 1024 / 1024)} MB`);
        console.log(`- Heap: ${Math.round(used.heapUsed / 1024 / 1024)} MB`);
        
        if (used.rss < 200 * 1024 * 1024) {
          console.log("âœ… Memory usage acceptable for Lemur");
        } else {
          console.log("âš ï¸ High memory usage for Lemur");
        }
        
        // Test 4: Check for Lemur specific features
        console.log("\n4. Lemur environment check...");
        const isTermux = process.env.TERMUX_VERSION || process.env.PREFIX === '/data/data/com.termux/files/usr';
        const isAndroid = process.platform === 'android';
        
        console.log(`- Platform: ${process.platform}`);
        console.log(`- Termux: ${isTermux ? 'Yes' : 'No'}`);
        console.log(`- Android: ${isAndroid ? 'Yes' : 'No'}`);
        
        if (isTermux || isAndroid) {
          console.log("âœ… Running in Android/Termux environment");
        } else {
          console.log("âš ï¸ Not in Android environment (simulated)");
        }
        
        console.log("\nâœ… Lemur compatibility test completed");
        console.log("ðŸ“± Bot is ready for Lemur Browser!");
        EOF
        
        # Run the test
        node lemur-test.js
        
    # Step 7: Start bot for Lemur test run
    - name: Run bot in Lemur simulation mode
      if: steps.validate-appstate.outputs.appstate-valid == 'true'
      run: |
        RUNTIME_MINUTES=${{ github.event.inputs.runtime }}
        RUNTIME_SECONDS=$((RUNTIME_MINUTES * 60))
        
        echo "ðŸš€ Starting bot in Lemur simulation mode..."
        echo "â° Will run for $RUNTIME_MINUTES minutes ($RUNTIME_SECONDS seconds)"
        echo "ðŸŒ Lemur Browser mode: ACTIVE"
        
        # Set Lemur environment variables
        export LEMUR_BROWSER=true
        export LEMUR_SIMULATION=true
        export NODE_OPTIONS="--max-old-space-size=512"
        
        # Start bot in background
        npm start &
        BOT_PID=$!
        
        echo "ðŸ“ Bot PID: $BOT_PID"
        echo $BOT_PID > lemur-bot.pid
        
        # Wait for initialization
        echo "â³ Initializing (30 seconds)..."
        sleep 30
        
        # Check if bot is running
        if ps -p $BOT_PID > /dev/null; then
          echo "âœ… Bot started successfully in Lemur mode"
          
          # Monitor for specified time
          echo "ðŸ“Š Monitoring bot for $RUNTIME_MINUTES minutes..."
          
          START_TIME=$(date +%s)
          END_TIME=$((START_TIME + RUNTIME_SECONDS))
          CURRENT_TIME=$START_TIME
          
          while [ $CURRENT_TIME -lt $END_TIME ]; do
            # Check if bot is still alive
            if ! ps -p $BOT_PID > /dev/null; then
              echo "âŒ Bot stopped unexpectedly"
              break
            fi
            
            # Calculate elapsed time
            ELAPSED=$((CURRENT_TIME - START_TIME))
            ELAPSED_MIN=$((ELAPSED / 60))
            ELAPSED_SEC=$((ELAPSED % 60))
            
            # Print status every 30 seconds
            if [ $((ELAPSED % 30)) -eq 0 ]; then
              echo "â±ï¸ Running for ${ELAPSED_MIN}m ${ELAPSED_SEC}s"
              
              # Check memory usage
              if command -v pmap &> /dev/null; then
                MEM_USAGE=$(pmap $BOT_PID | tail -1 | awk '{print $2}')
                echo "ðŸ’¾ Memory: $MEM_USAGE"
              fi
            fi
            
            sleep 1
            CURRENT_TIME=$(date +%s)
          done
          
          echo "â° Runtime completed"
        else
          echo "âŒ Bot failed to start"
          exit 1
        fi
        
    # Step 8: Stop bot gracefully
    - name: Stop Lemur simulation
      if: steps.validate-appstate.outputs.appstate-valid == 'true'
      run: |
        echo "ðŸ›‘ Stopping Lemur simulation..."
        
        if [ -f "lemur-bot.pid" ]; then
          BOT_PID=$(cat lemur-bot.pid)
          
          if [ -n "$BOT_PID" ] && ps -p $BOT_PID > /dev/null; then
            echo "Stopping bot PID: $BOT_PID"
            
            # Try graceful shutdown
            kill $BOT_PID 2>/dev/null || true
            sleep 10
            
            # Force kill if needed
            if ps -p $BOT_PID > /dev/null; then
              echo "Force stopping..."
              kill -9 $BOT_PID 2>/dev/null || true
            fi
            
            echo "âœ… Bot stopped"
          else
            echo "âš ï¸ Bot not running"
          fi
          
          rm -f lemur-bot.pid
        else
          echo "âš ï¸ No PID file found"
        fi
        
    # Step 9: Generate Lemur report
    - name: Generate Lemur deployment report
      if: always()
      run: |
        echo "ðŸ“‹ Generating Lemur Browser deployment report..."
        
        cat > LEMUR_DEPLOYMENT_REPORT.md << EOF
        # Lemur Browser Deployment Report
        
        ## Deployment Summary
        - **Date**: $(date)
        - **Repository**: ${{ github.repository }}
        - **Workflow**: ${{ github.workflow }}
        - **Run ID**: ${{ github.run_id }}
        - **Runtime**: ${{ github.event.inputs.runtime }} minutes
        - **Lemur Version**: ${{ github.event.inputs.lemur_version }}
        
        ## Results
        - **AppState Valid**: ${{ steps.validate-appstate.outputs.appstate-valid }}
        - **Status**: ${{ job.status }}
        
        ## Files Generated
        1. \`LEMUR_GUIDE.md\` - Setup guide for Lemur
        2. \`lemur-setup.sh\` - Automatic setup script
        3. \`package-lemur.json\` - Optimized package.json
        4. \`start-lemur.sh\` - Lemur start script
        
        ## Lemur Compatibility
        âœ… Node.js 18.x compatible  
        âœ… Low memory mode enabled  
        âœ… Termux environment tested  
        âœ… Android file system access  
        
        ## Next Steps for Users
        1. Download all files in Lemur Browser
        2. Run \`./lemur-setup.sh\`
        3. Login with \`npm run login\`
        4. Start with \`./start-lemur.sh\`
        
        ## Support
        - Developer: RANA (MASTER ðŸª“)
        - Email: ranaeditz333@gmail.com
        - For Lemur issues: Check Termux compatibility
        
        ## Notes
        This bot is optimized for Lemur Browser with:
        - Reduced memory footprint
        - Android file paths
        - Termux integration
        - Mobile-friendly setup
        EOF
        
        echo "âœ… Lemur report generated"
        
    # Step 10: Upload Lemur artifacts
    - name: Upload Lemur artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lemur-files
        path: |
          LEMUR_GUIDE.md
          lemur-setup.sh
          package-lemur.json
          start-lemur.sh
          LEMUR_DEPLOYMENT_REPORT.md
          lemur-test.js
        retention-days: 30
        
    # Step 11: Upload bot logs
    - name: Upload Lemur bot logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lemur-logs
        path: |
          data/logs/
          npm-debug.log*
        retention-days: 7
        
    # Step 12: Final summary
    - name: Lemur deployment summary
      run: |
        echo ""
        echo "==========================================="
        echo "           LEMUR BROWSER DEPLOYMENT        "
        echo "==========================================="
        echo ""
        echo "âœ… Deployment completed for Lemur Browser"
        echo ""
        echo "ðŸ“± **Lemur Browser Ready Files:**"
        echo "1. LEMUR_GUIDE.md - Complete setup guide"
        echo "2. lemur-setup.sh - Auto setup script"
        echo "3. start-lemur.sh - Optimized start script"
        echo ""
        echo "ðŸ”§ **Setup Instructions:**"
        echo "1. Download files in Lemur Browser"
        echo "2. Extract to folder"
        echo "3. Run: chmod +x lemur-setup.sh"
        echo "4. Run: ./lemur-setup.sh"
        echo "5. Login with: npm run login"
        echo "6. Start with: ./start-lemur.sh"
        echo ""
        echo "ðŸ“ž **Support:**"
        echo "Developer: RANA (MASTER ðŸª“)"
        echo "Email: ranaeditz333@gmail.com"
        echo ""
        echo "==========================================="
