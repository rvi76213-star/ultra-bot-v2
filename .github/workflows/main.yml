name: Deploy Messenger Bot

on:
  # Trigger on push to main branch
  push:
    branches: [ "main" ]
  
  # Trigger on schedule (every 6 hours)
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    # Step 1: Checkout code
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    # Step 2: Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
        
    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        npm ci
        echo "âœ… Dependencies installed"
        
    # Step 4: Check for appstate.json
    - name: Check appstate.json
      id: check_appstate
      run: |
        if [ -f "src/secure/appstate.json" ]; then
          echo "âœ… appstate.json found"
          echo "appstate_exists=true" >> $GITHUB_OUTPUT
          
          # Validate appstate
          FILE_SIZE=$(wc -c < "src/secure/appstate.json")
          if [ $FILE_SIZE -gt 100 ]; then
            echo "âœ… appstate.json is valid"
          else
            echo "âŒ appstate.json is empty or invalid"
            echo "appstate_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âŒ appstate.json not found"
          echo "appstate_exists=false" >> $GITHUB_OUTPUT
        fi
        
    # Step 5: Create necessary directories
    - name: Create directories
      run: |
        mkdir -p data/fun-json data/admin-photos data/logs config assets/owner-photos
        echo "âœ… Directories created"
        
    # Step 6: Create default config files if missing
    - name: Setup configuration
      run: |
        if [ ! -f "config/config.json" ]; then
          echo '{
            "prefix": "!",
            "admins": [],
            "autoAddFriend": true,
            "autoShare": true,
            "maxGroups": 50,
            "logLevel": "info",
            "language": "bn",
            "ownerName": "RANA (MASTER ðŸª“)",
            "ownerLocation": "Faridpur, Dhaka, Bangladesh",
            "ownerEmail": "ranaeditz333@gmail.com",
            "ownerPhone": "01847634486"
          }' > config/config.json
          echo "âœ… Created config.json"
        fi
        
        if [ ! -f "config/settings.json" ]; then
          echo '{
            "delay": {
              "min": 300,
              "max": 600
            },
            "photo": {
              "ownerCount": 12,
              "adminMax": 3
            },
            "security": {
              "maxCommandsPerMinute": 30,
              "blockSpam": true
            },
            "features": {
              "funEnabled": true,
              "autoReply": false,
              "welcomeMessage": true
            }
          }' > config/settings.json
          echo "âœ… Created settings.json"
        fi
        
    # Step 7: Create fun JSON files if missing
    - name: Create fun JSON files
      run: |
        # Create chor.json
        if [ ! -f "data/fun-json/chor.json" ]; then
          echo '[
            "à¦šà§‹à¦° à¦§à¦° à¦šà§‹à¦°! ðŸƒâ€â™‚ï¸",
            "à¦šà§‹à¦° à¦ªà¦¾à¦²à¦¾à¦šà§à¦›à§‡! ðŸš¨",
            "à¦§à¦° à¦§à¦° à¦šà§‹à¦°! ðŸ‘®",
            "à¦“à¦‡ à¦¯à§‡ à¦šà§‹à¦°! ðŸ•µï¸",
            "à¦šà§‹à¦° à¦§à¦°à¦¾ à¦ªà¦¡à¦¼à¦²! ðŸŽ‰",
            "à¦¸à¦¬à¦¾à¦‡ à¦®à¦¿à¦²à§‡ à¦šà§‹à¦° à¦§à¦°! ðŸ‘¥",
            "à¦šà§‹à¦°à§‡à¦° à¦¶à§‡à¦· à¦°à¦•à§à¦·à¦¾ à¦¨à¦¾à¦‡! âš–ï¸",
            "à¦šà§‹à¦° à¦¶à¦¨à¦¾à¦•à§à¦¤! ðŸ”",
            "à¦†à¦²à¦Ÿà§à¦°à¦¾ à¦šà§‹à¦°! ðŸ¦¸",
            "à¦šà§‹à¦° à¦­à¦¾à¦‡ à¦•à§‡à¦®à¦¨ à¦†à¦›à§‡à¦¨? ðŸ˜‚"
          ]' > data/fun-json/chor.json
          echo "âœ… Created chor.json"
        fi
        
        # Create murgi.json
        if [ ! -f "data/fun-json/murgi.json" ]; then
          echo '[
            "à¦®à§à¦°à¦—à¦¿ à¦‰à¦¡à¦¼à¦²! ðŸ”âœˆï¸",
            "à¦®à§à¦°à¦—à¦¿ à¦¡à¦¿à¦® à¦¦à¦¿à¦²! ðŸ¥š",
            "à¦•à§à¦•à¦¡à¦¼à¦¾ à¦•à§! ðŸ“",
            "à¦®à§à¦°à¦—à¦¿ à¦ªà¦¾à¦²à¦¾à¦šà§à¦›à§‡! ðŸƒâ€â™€ï¸",
            "à¦®à§à¦°à¦—à¦¿ à¦§à¦°! ðŸŽ¯",
            "à¦«à§à¦°à¦¾à¦‡à¦¡ à¦šà¦¿à¦•à§‡à¦¨! ðŸ—",
            "à¦®à§à¦°à¦—à¦¿à¦° à¦¬à¦¾à¦šà§à¦šà¦¾! ðŸ¤",
            "à¦•à§‹à¦°à¦¬à¦¾à¦¨à¦¿à¦° à¦®à§à¦°à¦—à¦¿! ðŸ•Œ",
            "à¦®à§à¦°à¦—à¦¿ à¦®à¦¾à¦° à¦–à¦¾à¦¯à¦¼! ðŸ¥Š",
            "à¦²à¦¿à¦­ à¦®à§à¦°à¦—à¦¿! ðŸ”"
          ]' > data/fun-json/murgi.json
          echo "âœ… Created murgi.json"
        fi
        
        # Create abal.json
        if [ ! -f "data/fun-json/abal.json" ]; then
          echo '[
            "à¦†à¦¬à¦¾à¦² à¦¶à§à¦°à§! ðŸŽ­",
            "à¦†à¦¬à¦¾à¦² à¦Ÿà¦¾à¦‡à¦®! â°",
            "à¦†à¦¬à¦¾à¦² à¦†à¦¬à¦¾à¦²! ðŸ¤ª",
            "à¦†à¦¬à¦¾à¦² à¦®à§‹à¦¡ à¦à¦•à§à¦Ÿà¦¿à¦­à§‡à¦Ÿ! ðŸš€",
            "à¦†à¦¬à¦¾à¦² à¦ªà¦¾à¦“à¦¯à¦¼à¦¾à¦°! ðŸ’ª",
            "à¦†à¦¬à¦¾à¦² à¦²à§‡à¦­à§‡à¦² à¦®à§à¦¯à¦¾à¦•à§à¦¸! ðŸ“ˆ",
            "à¦†à¦¬à¦¾à¦² à¦—à§‡à¦® à¦¶à§à¦°à§! ðŸŽ®",
            "à¦†à¦¬à¦¾à¦² à¦…à§à¦¯à¦¾à¦Ÿà¦¾à¦•! âš”ï¸",
            "à¦†à¦¬à¦¾à¦² à¦¡à¦¿à¦«à§‡à¦¨à§à¦¸! ðŸ›¡ï¸",
            "à¦†à¦¬à¦¾à¦² à¦«à¦¾à¦‡à¦¨à¦¾à¦²! ðŸ†"
          ]' > data/fun-json/abal.json
          echo "âœ… Created abal.json"
        fi
        
        # Create senior.json
        if [ ! -f "data/fun-json/senior.json" ]; then
          echo '[
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦à¦²à§‹! ðŸ‘´",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦°à§‡à¦° à¦¸à¦®à§à¦®à¦¾à¦¨! ðŸ™",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦Ÿà¦¿à¦šà¦¾à¦°! ðŸ‘¨â€ðŸ«",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦…à§à¦¯à¦¾à¦¡à¦­à¦¾à¦‡à¦¸! ðŸ’¡",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾à¦°! ðŸ”¥",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦®à§‹à¦¡! ðŸŽ©",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦•à¦®à§à¦¯à¦¾à¦¨à§à¦¡! âš¡",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦ªà§à¦°à§‡à¦œà§‡à¦¨à§à¦¸! ðŸ‘‘",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦¬à§à¦¦à§à¦§à¦¿! ðŸ§ ",
            "à¦¸à¦¿à¦¨à¦¿à¦¯à¦¼à¦° à¦«à¦¾à¦‡à¦¨à¦¾à¦²! ðŸ"
          ]' > data/fun-json/senior.json
          echo "âœ… Created senior.json"
        fi
        
        # Create cow.json
        if [ ! -f "data/fun-json/cow.json" ]; then
          echo '[
            "à¦—à¦°à§ à¦®à§‹! ðŸ„",
            "à¦—à¦°à§ à¦šà¦°à¦›à§‡! ðŸŒ¾",
            "à¦—à¦°à§à¦° à¦¦à§à¦§! ðŸ¥›",
            "à¦—à¦°à§ à¦ªà¦¾à¦²! ðŸ®",
            "à¦—à¦°à§ à¦®à¦¾à¦°à§à¦•à§‡à¦Ÿ! ðŸª",
            "à¦—à¦°à§ à¦¹à¦¾à¦®à§à¦¬à¦¾! ðŸ”Š",
            "à¦—à¦°à§ à¦°à§‡à¦¸! ðŸƒâ€â™‚ï¸",
            "à¦—à¦°à§ à¦«à¦¾à¦°à§à¦®! ðŸžï¸",
            "à¦—à¦°à§ à¦¬à¦¾à¦šà§à¦šà¦¾! ðŸ‚",
            "à¦—à¦°à§ à¦•à¦¿à¦‚! ðŸ‘‘"
          ]' > data/fun-json/cow.json
          echo "âœ… Created cow.json"
        fi
        
        # Create goat.json
        if [ ! -f "data/fun-json/goat.json" ]; then
          echo '[
            "à¦›à¦¾à¦—à¦² à¦®à§‡! ðŸ",
            "à¦›à¦¾à¦—à¦² à¦šà¦°à¦›à§‡! ðŸŒ¿",
            "à¦›à¦¾à¦—à¦²à§‡à¦° à¦¦à§Œà¦¡à¦¼! ðŸƒ",
            "à¦›à¦¾à¦—à¦² à¦°à¦¾à¦œà¦¾! ðŸ¤´",
            "à¦›à¦¾à¦—à¦² à¦†à¦°à§à¦Ÿà¦¿à¦¸à§à¦Ÿ! ðŸŽ¨",
            "à¦›à¦¾à¦—à¦² à¦œà¦¾à¦®à§à¦ª! ðŸ¦˜",
            "à¦›à¦¾à¦—à¦² à¦«à§à¦¯à¦¾à¦®à¦¿à¦²à¦¿! ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
            "à¦›à¦¾à¦—à¦² à¦ªà¦²à¦¿à¦Ÿà¦¿à¦¶à¦¿à¦¯à¦¼à¦¾à¦¨! ðŸŽ­",
            "à¦›à¦¾à¦—à¦² à¦¸à§à¦Ÿà¦¾à¦‡à¦²! ðŸ’ƒ",
            "à¦›à¦¾à¦—à¦² à¦²à¦¿à¦œà§‡à¦¨à§à¦¡! ðŸŒŸ"
          ]' > data/fun-json/goat.json
          echo "âœ… Created goat.json"
        fi
        
    # Step 8: Start the bot (if appstate exists)
    - name: Start Messenger Bot
      if: steps.check_appstate.outputs.appstate_exists == 'true'
      run: |
        echo "ðŸš€ Starting YOUR CRUSH Bot..."
        echo "ðŸ‘‘ Developer: RANA (MASTER ðŸª“)"
        echo "ðŸ“ Location: Faridpur, Dhaka, Bangladesh"
        echo ""
        
        # Start the bot in background
        npm start &
        BOT_PID=$!
        
        # Save PID to file for later use
        echo $BOT_PID > /tmp/bot_pid.txt
        
        # Wait for bot to initialize
        echo "â³ Waiting for bot to initialize..."
        sleep 30
        
        # Check if bot is running
        if ps -p $BOT_PID > /dev/null; then
          echo "âœ… Bot is running with PID: $BOT_PID"
        else
          echo "âŒ Bot failed to start"
          exit 1
        fi
        
    # Step 9: Keep bot alive for specified time
    - name: Keep bot running
      if: steps.check_appstate.outputs.appstate_exists == 'true'
      run: |
        echo "â° Bot will run for 5 minutes..."
        
        # Run for 5 minutes (300 seconds)
        for i in {1..300}; do
          # Check if bot is still running
          BOT_PID=$(cat /tmp/bot_pid.txt 2>/dev/null || echo "")
          
          if [ -z "$BOT_PID" ] || ! ps -p $BOT_PID > /dev/null; then
            echo "âŒ Bot stopped unexpectedly at $i seconds"
            break
          fi
          
          # Every 30 seconds, log status
          if [ $((i % 30)) -eq 0 ]; then
            MINUTES=$((i / 60))
            SECONDS=$((i % 60))
            echo "âœ… Bot running for ${MINUTES}m ${SECONDS}s"
          fi
          
          sleep 1
        done
        
        echo "â° 5 minutes completed"
        
    # Step 10: Stop the bot
    - name: Stop Messenger Bot
      if: steps.check_appstate.outputs.appstate_exists == 'true'
      run: |
        echo "ðŸ›‘ Stopping bot..."
        
        # Read PID from file
        BOT_PID=$(cat /tmp/bot_pid.txt 2>/dev/null || echo "")
        
        if [ -n "$BOT_PID" ] && ps -p $BOT_PID > /dev/null; then
          # Send SIGTERM to bot
          kill $BOT_PID
          sleep 5
          
          # Force kill if still running
          if ps -p $BOT_PID > /dev/null; then
            kill -9 $BOT_PID
          fi
          
          echo "âœ… Bot stopped successfully"
        else
          echo "âš ï¸ Bot was not running"
        fi
        
        # Cleanup PID file
        rm -f /tmp/bot_pid.txt
        
    # Step 11: Upload logs as artifact
    - name: Upload bot logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: bot-logs
        path: |
          data/logs/
          npm-debug.log*
        retention-days: 7
        
    # Step 12: Save workflow status
    - name: Save workflow status
      if: always()
      run: |
        STATUS=$([ "${{ job.status }}" == "success" ] && echo "SUCCESS" || echo "FAILURE")
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        echo "Workflow Status: $STATUS" >> workflow-status.txt
        echo "Timestamp: $TIMESTAMP" >> workflow-status.txt
        echo "AppState Exists: ${{ steps.check_appstate.outputs.appstate_exists }}" >> workflow-status.txt
        echo "Run Reason: ${{ github.event.inputs.reason || github.event_name }}" >> workflow-status.txt
        
    # Step 13: Upload workflow status
    - name: Upload workflow status
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: workflow-status
        path: workflow-status.txt
        
    # Step 14: Send notification (Optional - needs setup)
    - name: Send notification
      if: always()
      run: |
        echo "ðŸ“‹ Workflow completed: ${{ job.status }}"
        echo "ðŸ”— Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # You can add Discord/Telegram/Email notification here
        # Example for Discord webhook:
        # curl -H "Content-Type: application/json" \
        #   -d "{\"content\":\"GitHub Action completed: ${{ job.status }}\nRepository: ${{ github.repository }}\"}" \
        #   YOUR_DISCORD_WEBHOOK_URL
