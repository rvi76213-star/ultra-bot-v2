name: Run Messenger Bot

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout code
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Step 2: Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    # Step 3: Install dependencies
    - name: Install dependencies
      run: npm install
      
    # Step 4: Check appstate.json
    - name: Check appstate.json
      id: check-appstate
      run: |
        if [ -f "src/secure/appstate.json" ]; then
          echo "âœ… appstate.json exists"
          echo "appstate-exists=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ appstate.json not found"
          echo "appstate-exists=false" >> $GITHUB_OUTPUT
        fi
        
    # Step 5: Create missing files
    - name: Setup configuration
      run: |
        mkdir -p config data/fun-json data/logs
        
        if [ ! -f "config/config.json" ]; then
          cat > config/config.json << 'EOF'
{
  "prefix": "!",
  "admins": [],
  "autoAddFriend": true,
  "autoShare": true,
  "maxGroups": 50,
  "logLevel": "info",
  "language": "bn",
  "ownerName": "RANA (MASTER ðŸª“)",
  "ownerLocation": "Faridpur, Dhaka, Bangladesh",
  "ownerEmail": "ranaeditz333@gmail.com",
  "ownerPhone": "01847634486"
}
EOF
          echo "âœ… Created config.json"
        fi
        
        if [ ! -f "config/settings.json" ]; then
          cat > config/settings.json << 'EOF'
{
  "delay": {
    "min": 300,
    "max": 600
  },
  "photo": {
    "ownerCount": 12,
    "adminMax": 3
  },
  "security": {
    "maxCommandsPerMinute": 30,
    "blockSpam": true
  },
  "features": {
    "funEnabled": true,
    "autoReply": false,
    "welcomeMessage": true
  }
}
EOF
          echo "âœ… Created settings.json"
        fi
        
    # Step 6: Start bot
    - name: Start Messenger Bot
      if: steps.check-appstate.outputs.appstate-exists == 'true'
      run: |
        echo "ðŸš€ Starting YOUR CRUSH Bot..."
        
        # Start bot in background
        npm start &
        BOT_PID=$!
        echo $BOT_PID > bot.pid
        
        echo "â³ Waiting 30 seconds..."
        sleep 30
        
        if ps -p $BOT_PID > /dev/null; then
          echo "âœ… Bot is running"
        else
          echo "âŒ Bot failed to start"
          exit 1
        fi
        
    # Step 7: Run for 5 minutes
    - name: Run bot for 5 minutes
      if: steps.check-appstate.outputs.appstate-exists == 'true'
      run: |
        echo "â° Running for 5 minutes..."
        
        BOT_PID=$(cat bot.pid)
        
        for i in {1..300}; do
          if ! ps -p $BOT_PID > /dev/null; then
            echo "âŒ Bot stopped at $i seconds"
            break
          fi
          
          if [ $((i % 60)) -eq 0 ]; then
            minutes=$((i / 60))
            echo "âœ… $minutes minute(s) passed"
          fi
          
          sleep 1
        done
        
        echo "â° 5 minutes completed"
        
    # Step 8: Stop bot
    - name: Stop bot
      if: steps.check-appstate.outputs.appstate-exists == 'true'
      run: |
        echo "ðŸ›‘ Stopping bot..."
        
        if [ -f "bot.pid" ]; then
          BOT_PID=$(cat bot.pid)
          if [ -n "$BOT_PID" ]; then
            kill $BOT_PID 2>/dev/null || true
            sleep 5
          fi
          rm -f bot.pid
        fi
        
        echo "âœ… Bot stopped"
        
    # Step 9: Upload logs
    - name: Upload bot logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-logs
        path: |
          data/logs/
          npm-debug.log*
        
    # Step 10: Summary
    - name: Workflow summary
      run: |
        echo "ðŸ“‹ Workflow Status"
        echo "=================="
        echo "Status: ${{ job.status }}"
        echo "AppState: ${{ steps.check-appstate.outputs.appstate-exists }}"
        echo "Time: $(date)"
