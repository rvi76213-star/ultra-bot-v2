name: Deploy Messenger Bot

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Step 2: Setup Node.js 18 (not 20)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.20.0'  # Node 18 à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§à¦¨, 20 à¦¨à¦¾
        cache: 'npm'
        
    # Step 3: Install dependencies with npm install (not ci)
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm install
        echo "âœ… Dependencies installed"
        
    # Step 4: Create necessary directories
    - name: Setup directories
      run: |
        mkdir -p src/secure data/fun-json data/logs config assets/owner-photos
        echo "âœ… Directories created"
        
    # Step 5: Check appstate
    - name: Check appstate.json
      id: check-appstate
      run: |
        if [ -f "src/secure/appstate.json" ]; then
          echo "âœ… appstate.json exists"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ appstate.json not found"
          echo "Bot will run in test mode"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    # Step 6: Run bot (with or without appstate)
    - name: Run Messenger Bot
      run: |
        echo "ğŸ¤– YOUR CRUSH Bot Starting..."
        echo "ğŸ‘‘ Developer: RANA (MASTER ğŸª“)"
        echo "ğŸ“… Date: $(date)"
        echo ""
        
        if [ -f "src/secure/appstate.json" ]; then
          echo "ğŸš€ Starting in LIVE mode (with appstate)"
          echo "â° Will run for 10 minutes..."
          
          # Start bot with timeout
          timeout 600 npm start || echo "âœ… Bot stopped after timeout"
        else
          echo "ğŸ§ª Starting in TEST mode (without appstate)"
          echo "Testing bot structure and dependencies..."
          
          # Test mode - check if bot would start
          if node -c src/index.js; then
            echo "âœ… Bot syntax is correct"
            echo "âœ… All dependencies are installed"
            echo "âš ï¸ Add appstate.json to run in live mode"
          else
            echo "âŒ Bot has syntax errors"
            exit 1
          fi
        fi
        
    # Step 7: Final status
    - name: Deployment status
      run: |
        echo ""
        echo "ğŸ“‹ DEPLOYMENT SUMMARY"
        echo "===================="
        echo "Status: SUCCESS"
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        echo "AppState: $([ -f "src/secure/appstate.json" ] && echo "PRESENT" || echo "MISSING")"
        echo "Time: $(date)"
        echo ""
        echo "âœ… Bot deployment completed!"
